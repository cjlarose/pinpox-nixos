kind: pipeline
type: exec
name: Build all hosts

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:
- name: Show flake info
  commands:
  - ssh-add - <<< "${SSH_DEPLOY_KEY}"
  - nix --experimental-features "nix-command flakes" flake show
  - nix --experimental-features "nix-command flakes" flake metadata
- name: Run flake checks
  commands:
  - nix --experimental-features "nix-command flakes" flake check --show-trace
- name: Build kartoffel
  commands:
  - nix build -v -L '.#nixosConfigurations.kartoffel.config.system.build.toplevel'
- name: Build ahorn
  commands:
  - nix build -v -L '.#nixosConfigurations.ahorn.config.system.build.toplevel'
- name: Build porree
  commands:
  - nix build -v -L '.#nixosConfigurations.porree.config.system.build.toplevel'
- name: Build kfbox
  commands:
  - nix build -v -L '.#nixosConfigurations.kfbox.config.system.build.toplevel'
- name: Build bob
  commands:
  - nix build -v -L '.#nixosConfigurations.bob.config.system.build.toplevel'
- name: Build birne
  commands:
  - nix build -v -L '.#nixosConfigurations.birne.config.system.build.toplevel'
- name: Notify
  commands:
    - 'nix run "github:mic92/nur-packages#irc-announce" -- irc.hackint.org 6697 bob-the-builder "#lounge-rocks-log" 1 "🛠️ [$DRONE_REPO] ($DRONE_BUILD_EVENT) $DRONE_BUILD_STATUS | $DRONE_COMMIT_MESSAGE" || true'
  environment:
    LOGNAME: drone
    SSH_DEPLOY_KEY:
      from_secret: gitea_deploy_key
  when:
    status:
    - failure
    - success

trigger:
  branch:
  - main
  - test-sops-nix
  event:
  - push


---
kind: secret
name: gitea_deploy_key
data: iBrvbXBQwubLz7gYlRFC8uDRjMtIRmmqGwJ9eC3iMbMxXijFjI270OE4mUkPtq5fFny2Vak/VNqKED3yWzSQ9m4lC3ho4pQs6ahRs1vBNj6YddhichI9Yo0p5LoK4e/gfHfqIOa761CzxXyAY85RmBA8Q21HvLGzPOu0ARDxo9rxjHIefzQeIMyborqSpS9+eHhYxJfq+89F1/gRenYAWbCpsynnlZXMyxPA4Yox3+cWyH37d4mYbqfB6Sb1H2rxaXWL2MIIBM+hr1IsB/+/uPshHEsPtSMmYwO1ZfJA0Mqs1O9UifFkMd3qUR5ZBgc1BlAWYSCMxtKdTUEY01aScdcNgbF5oKe746X78BwzPprAP443AnW0cbyaOB3baA5sXpeKVwPQxxCJQIrkmAVTQEpWacO3XsBbpsuhQ6nsFgFazwd4N2tAk3F4D/CsH2CoxghLx1YJUWHg2yaMouxeyWWRf97Bg0VnNuXcskK2qqJIBmNMef6ukj4BsN4qFTaUbodPduayu1Ygf+gEJ1dvOGjoPH1SiwS+dTm0OsSSUjCKbqWkvV2Oh2C1xw==
---
kind: pipeline
type: docker
name: Update Flakes

steps:
- name: Update flake.lock
  image: nixpkgs/nix-flakes
  commands:
  - nix flake update
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

- name: Push updated flake.lock
  image: appleboy/drone-git-push
  settings:
    branch: update-flake
    remote: git@github.com:pinpox/nixos.git
    force: true
    commit: true
    commit_message: "❄ Update flake.lock"
    ssh_key:
      from_secret: deploy_key

trigger:
  event:
  - cron
  cron:
  - daily

